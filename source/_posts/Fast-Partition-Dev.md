---
title: Fast_Partition_Dev
date: 2025-04-08 20:11:38
tags:
---
本文介绍并回顾视频编解码中快速划分算法的发展，主要聚焦于新兴的机器学习方法，对比各方法的不同划分表征方式和后处理模式。

在HEVC视频编解码标准下，划分方法仅存在QT四划分。在视频编码的过程中，决定一个CTU块的划分是一个自上而下的迭代过程。编码器会从最大的CTU块开始执行判决，计算划分与不划分两种情况分别的代价，选择代价更小的方式。若判决需要划分，则QT四划分会将原64x64的编码块划分为四个32x32的编码块，在迭代进行是否划分的判决，直至编码块大小达到规定最小尺寸或CTU中的各子CU编码块均判决为不再划分。在这一判决过程中，代价计算综合了码率和失真这两要素，广泛采用SAD或SATD代价，计算公式如下。

因此，这一过程被称为RDO过程，即Rate-Distortion Optimization。在RDO过程中，一个编码块的代价计算应为其所有子编码块代价之和，即划分情况下，编码块的代价应为各子划分块的代价；不划分情况下，编码块的代价则以当前编码块的尺寸进行数学计算。因此，可以发现，RDO过程是通过不断地迭代计算得到所有划分情况的代价，整体的迭代过程是自顶向下的，而代价计算和判断是自下向上的。

在VVC标准中，正式引入了QTMT划分。QTMT划分在四叉树的基础上增加了二叉树和三叉树的划分方式，因此VVC中RDO的划分判决共有6类，BTH划分、BTV划分、QT划分、TTH划分、TTV划分和不划分，相比于原有的划分种类扩展了近3倍，再带来编码性能提升的同时大大增加了RDO判决的复杂度，是编码过程中极耗时的部分。因此，相关的工作主要集中于快速编码算法的发展。这些快速编码算法只要可分为两种思路，一种是传统的基于统计学的剪枝算法，根据一定的图像块特征和模式的统计学结果减少需要检索的划分类型或提前中止划分。另一种是基于机器学习的AI算法，对于视频各帧的处理即为对于一张完整图像的处理，因此计算机视觉领域的相关思路和算法模式可被应用其中。

（一）
来自ICIP 2018的Fast QTBT Partitioning Decision for Interframe Coding with Convolution Neural Network是最早将卷积神经网络应用于帧间QTBT快速划分判决的工作。本篇文章中卷积神经网络的结构是作者对于QTBT划分结果进行统计学分析从而得到启发。

首先，在整体网络任务上，将快速划分问题归类为多分类问题。然而，由于不同的划分会产生不同尺寸的图像，难以设计一个统一的网络接受不同尺寸的输入并进行分类，因此作者通过统一的深度表示来对QTBT划分结构进行建模。深度定义为，QT深度的两倍叠加BT深度。（注意，该篇文章为HEVC到VVC的过渡阶段工作，此时仅引入BT划分，不存在MT划分）最大CTU块规定为128x128，最小QT划分块规定为16x16，故最大QT深度为3，最小CU尺寸为4x4，故最大BT划分深度规定为4，（先进行完QT划分才会执行BT划分），总QTBT统一深度的取值范围为0到10。这一统一深度的表示是指所考虑的CU块中的最大深度，即如果CU块中存在需要划分到最小尺寸4x4的情况，那么该CU块的统一深度表示即为10。因此，很容易理解这样一个统计学事实，即128x128尺寸的CU的统一深度表示会在分布上存在偏差，有将近50%的情况需要划分到最大深度，因为CU的尺寸很大，所包含的纹理空间也相应很大，存在复杂纹理的情况也更加普遍。而对于64x64尺寸的CU和32x32尺寸的CU来说，统一深度表示的分布更加平均，因为小尺寸纹理空间包含的范围更小，出现复杂纹理和平滑纹理的情况更加平均，适合用来训练。最终本文选取64x64尺寸的CU作为输入，并且为了避免过拟合，将深度进行归类形成待分类的种类。

![image-20250331163346677](image-20250331163346677.png)

具体的CNN网络结构见下图，

![image-20250331163245256](image-20250331163245256.png)

首先前处理执行一个简单的运动补偿过程获得待编码块的参考块，相减得到残差块，残差块隐含视频序列的时域冗余信息，相比原始参考块像素是更有力的特征表示。残差块减去平均值后作为网络输入，经过三层卷积层提取特征并最终连接展平为一个特征向量，随后考虑量化参数qp和参考的时域层数两个特征，将三者进行非线性地融合并通过全连接层输出分类结果。损失函数考虑网络权重矩阵的大小和分类结果与原始结果的差值（即准确率）。

获得分类结果后，快速划分的后处理方法如下：

![image-20250331165615216](image-20250331165615216.png)

对于一个CTU进行划分判决时，首先会直接将128x128大小的CU划分为64x64大小的子块，根据网络推理结果得到对应子块的最大划分深度$d_i$。然后，对于参考块也进行类似操作，得到对应参考块的预测最大划分深度$d_i^{'}$，由于参考块是已编码重建块，故实际最大划分深度已知为$D_i^{'}$。

修正子块的预测深度为
$$
\begin{equation}
d_i=d_i+max \\{ D_i^{'}-d_i^{'},0 \\}
\end{equation}
$$
含义为：若参考块预测正确，则接受子块的预测结果；若参考块预测值偏大，则保留子块的偏大预测结果以保证足够划分深度用以进行判决；若参考块预测值偏小，则子块预测值需进行补偿。

获得四个子64x64块的预测深度后，原128x128CTU块将根据预测深度开启划分判决。若四个子块预测深度均为0，说明最小划分尺寸为64x64，因此128x128尺寸的CTU块将进行深度不超过2的划分判决以决定最佳划分模式。若仅存在一个子块预测深度不为0，则128x128尺寸的CTU块将正常执行QTBT划分判决，只是64x64子块的划分无需判断提前终止。若多个子块预测深度不为0，那么128x128尺寸CTU块会直接执行QT划分，然后对应64x64子块会根据预测划分深度进行判定和提前终止。

总结：本文的工作作为HEVC到VVC的过度工作被纳入VVC的标准中，但由于时间比较久远，从现在VVC的QTMT划分结构的角度来看，本文提出的统一深度表示不再能表示复杂的QTMT结构。不过本文的思想值得进行归纳，首先需明确网络的多分类任务是针对单个块的纹理复杂度进行粗分，最终仅能得到反映编码块整体深度的一个粗糙表示，在后处理中服务于划分判决的提前终止（剪枝思想）。更加理想的多分类任务应针对划分模式进行预测，从而可以获得更加细节的表示。在本文所提出的后处理结构中，针对64x64及更小尺寸的块划分并没有加速，这也是这一整体性深度表示方法的劣势。

